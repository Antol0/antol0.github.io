<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikacja do Nauki Zarządzania</title>
    <style>
        /* Proste style CSS, aby aplikacja ładnie wyglądała */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            display: flex;
            flex-direction: column; /* Zmienione na kolumnę, aby elementy układały się pionowo */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px; /* Dodany odstęp od dołu, jeśli reklama jest pod nim */
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        #sentence {
            font-size: 1.4em;
            margin-bottom: 25px;
            line-height: 1.6;
            min-height: 50px; /* Aby tekst nie skakał */
        }

        .blank-space {
            display: inline-block;
            width: 150px; /* Długość podkreślenia */
            border-bottom: 2px solid #3498db;
            text-align: center;
        }

        #answerInput {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1.1em;
            box-sizing: border-box;
            transition: box-shadow 0.4s ease-in-out, border-color 0.4s ease-in-out; /* Zwiększona płynność przejścia */
        }

        /* Udoskonalona klasa CSS dla zielonej poświaty */
        .input-correct-glow {
            border-color: #27ae60; /* Wyraźniejsza zielona ramka */
            box-shadow: 0 0 25px rgba(39, 174, 96, 0.8); /* Intensywniejsza zielona poświata */
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px; /* Odstęp między przyciskami */
            flex-wrap: wrap; /* Aby przyciski przechodziły do nowej linii na małych ekranach */
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            min-width: 150px;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        #feedback {
            margin-top: 25px;
            font-size: 1.2em;
            padding: 10px;
            border-radius: 6px;
            min-height: 40px; /* Aby tekst nie skakał */
            border: 1px solid transparent; /* Domyślna ramka, by nie skakało przy zmianie */
        }

        .feedback-correct {
            background-color: #e6ffe6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .feedback-incorrect {
            background-color: #ffe6e6;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .feedback-warning { /* Styl dla komunikatu o pustej odpowiedzi */
            background-color: #fffacd;
            color: #e67e22;
            border: 1px solid #e67e22;
        }


        .results {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 30px;
        }

        #incorrectAnswersSummary {
            margin-top: 30px;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        #incorrectAnswersSummary h2 {
            color: #e74c3c;
            font-size: 1.6em;
            margin-bottom: 15px;
        }

        #incorrectAnswersSummary ul {
            list-style: none;
            padding: 0;
        }

        #incorrectAnswersSummary li {
            background-color: #fffafa;
            border: 1px solid #ffcccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 1.1em;
            line-height: 1.5;
        }

        #incorrectAnswersSummary .original-sentence {
            font-weight: bold;
            color: #333;
        }

        #incorrectAnswersSummary .your-answer {
            color: #e74c3c;
            font-weight: bold;
        }

        #incorrectAnswersSummary .correct-answer {
            color: #27ae60;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        /* Style dla paska postępu */
        #progressBarContainer {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 20px;
            height: 10px; /* Wysokość paska */
            overflow: hidden; /* Upewnij się, że pasek postępu nie wychodzi poza kontener */
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background-color: #3498db;
            border-radius: 5px;
            transition: width 0.5s ease-in-out; /* Płynne przejście szerokości */
        }

        /* Style dla historii wyników */
        #resultsHistory {
            margin-top: 40px;
            text-align: left;
            border-top: 1px solid #eee;
            padding-top: 20px;
            width: 100%;
        }

        #resultsHistory h2 {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 15px;
        }

        #resultsHistory ul {
            list-style: none;
            padding: 0;
        }

        #resultsHistory li {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            font-size: 1.1em;
            line-height: 1.5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #resultsHistory .score-text {
            font-weight: bold;
            color: #3498db;
        }

        #resultsHistory .date-text {
            font-size: 0.9em;
            color: #777;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Uzupełnij Brakujące Słowo</h1>
        <p id="questionNumber" style="font-size: 0.9em; color: #777; margin-bottom: 15px;"></p>
        
        <div id="progressBarContainer">
            <div id="progressBar"></div>
        </div>

        <p id="sentence"></p>
        <input type="text" id="answerInput" placeholder="Wpisz brakujące słowo" autocomplete="off" aria-label="Wpisz brakujące słowo w zdaniu">

        <div class="button-group">
            <button id="checkButton">Sprawdź</button>
            <button id="hintButton">Podpowiedź</button>
            <button id="endTestButton">Zakończ Test</button>
            <button id="nextButton" class="hidden">Następne Pytanie</button>
            <button id="retakeIncorrectButton" class="hidden" style="background-color: #e67e22;">Powtórz błędne</button>
            <button id="restartButton" class="hidden">Zacznij od Nowa (wszystkie)</button>
        </div>

        <p id="feedback" class="hidden" aria-live="polite"></p>
        <p id="finalScore" class="hidden results" aria-live="polite"></p>

        <div id="incorrectAnswersSummary" class="hidden">
            <h2>Pytania z błędnymi odpowiedziami:</h2>
            <ul></ul>
        </div>

        <div id="resultsHistory" class="hidden">
            <h2>Historia Twoich Wyników</h2>
            <ul id="historyList"></ul>
        </div>
    </div>

    <div style="
        border: 1px solid #ffdd44; /* Cieńsza żółta ramka */
        background-color: #fffaf0; /* Jaśniejsze tło */
        padding: 10px; /* Zmniejszony padding */
        margin: 15px auto; /* Mniejsze odstępy */
        max-width: 300px; /* Znacznie mniejsza szerokość */
        text-align: center;
        font-family: 'Arial', sans-serif;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08); /* Delikatniejszy cień */
        border-radius: 6px;
        font-size: 0.9em; /* Ogólnie mniejsza czcionka */
    ">
        <p style="color: #e67e22; margin-bottom: 5px; font-weight: bold;">Ucz się szybciej!</p>
        <p style="font-size: 0.85em; color: #333;">Zobacz "Super Skrót Zarządzania"! ✨</p>
        <a href="https://ue.poznan.pl/osoby/dr-hab-gabriela-roszyk-kowalska/" target="_blank" style="
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 6px 12px; /* Mniejszy przycisk */
            border-radius: 4px;
            text-decoration: none;
            margin-top: 10px;
            font-size: 0.8em; /* Mniejsza czcionka przycisku */
        ">KLIKNIJ TUTAJ</a>
        <p style="font-size: 0.6em; color: #999; margin-top: 8px;">*Dla ambitnych studentów. Sprawdź warunki.</p>
    </div>
    <script>
        // --- Baza pytań ---
        // WAŻNE: Tutaj możesz edytować swoje pytania!
        // Użyj "___" (trzy podkreślenia) w miejscu, gdzie ma być brakujące słowo.
        // Pamiętaj o przecinku po każdym pytaniu (oprócz ostatniego)!
        // Dodano opcjonalne pole "alternative_answers" dla synonimów/bliskich odpowiedzi
        const questions = [
            {
                "sentence_template": "Wysoki poziom dbałości o personel jest w modelu Likerta jest charakterystyczny dla ___ stylu kierowania.",
                "correct_answer": "partycypacyjnego",
                "alternative_answers": ["partycypacyjny"], // Dodano alternatywną odpowiedź
                "hint": "Model Likerta, dotyczy partycypacji pracowników."
            },
            {
                "sentence_template": "Każdą sytuację zgodnie z modelem Fiedlera można opisać za pomocą trzech wymiarów: pozycji władczej kierownika, struktury zadania, stosunków pomiędzy podwładnym a ___.",
                "correct_answer": "przełożonym",
                "alternative_answers": ["przelozonym"],
                "hint": "Fiedler skupiał się na relacjach w zespole."
            },
            {
                "sentence_template": "Decyzje podejmuje się wolniej stosując styl ___ a nie autokratyczny.",
                "correct_answer": "demokratyczny",
                "alternative_answers": ["demokratycznego"],
                "hint": "Przeciwieństwo autokratycznego stylu zarządzania."
            },
            {
                "sentence_template": "Decyzje podejmuje się szybciej stosując styl ___ a nie demokratyczny.",
                "correct_answer": "autokratyczny",
                "alternative_answers": ["autokratycznego"],
                "hint": "Przeciwieństwo demokratycznego stylu zarządzania."
            },
            {
                "sentence_template": "Proces tworzenia organizacji to ___ znaczenie organizacji.",
                "correct_answer": "czynnościowe",
                "hint": "Dotyczy procesu, a nie cech czy układu."
            },
            {
                "sentence_template": "W modelu organizacji według Leavita wyróżniamy: cele i zadania, ludzi, strukturę i ___.",
                "correct_answer": "technologię",
                "alternative_answers": ["technologie"],
                "hint": "Czwarty element modelu Leavita."
            },
            {
                "sentence_template": "Zgodnie z modelem organizacji 7-S Mc Kinsey'a sukces organizacji jest silnie determinowany ___ - elementami zarządzania.",
                "correct_answer": "miękkimi",
                "alternative_answers": ["miekimi", "czynnikami miękkimi"],
                "hint": "McKinsey'a 7-S, co oznacza 'miękkie' elementy?"
            },
            {
                "sentence_template": "Sytuacja pojawiająca się wtedy, kiedy okoliczności pozwalają na osiągnięcie wyników lepszych od zaplanowanych to w procesie podejmowania decyzji mamy do czynienia z ___.",
                "correct_answer": "okazją",
                "hint": "Coś pozytywnego, co można wykorzystać."
            },
            {
                "sentence_template": "Mintzberg dokonał podziału decyzji na: _______, _______ i ___.",
                "correct_answer": "przedsiębiorcze adaptacyjne planistyczne",
                "alternative_answers": ["przedsiębiorcze adaptacyjne i planistyczne", "przedsiębiorcze, adaptacyjne i planistyczne", "przedsiębiorcze, adaptacyjne, planistyczne", "przedsiebiorcze adaptacyjne planistyczne"], // Dodano alternatywne odpowiedzi z/bez przecinków, bez polskich znaków
                "hint": "Rodzaje decyzji według Mintzberga."
            },
            {
                "sentence_template": "Zgodnie z paradygmatem ___ Organizacja jest systemem społecznym zdolnym do osiągania celów.",
                "correct_answer": "behawioralnym",
                "hint": "Paradygmat, który skupia się na zachowaniu."
            },
            {
                "sentence_template": "Wyróżniamy następujące wytyczne alternatywne sprawnego działania: _______ - uniwersalizacja, aktywizacja działania - minimalizacja interwencji, _______ - antycypacja; potencjalizacja - pełne wykorzystanie zasobów; ___ - dywersyfikacja działania.",
                "correct_answer": "specjalizacja kunktacja koncentracja sił",
                "alternative_answers": ["specjalizacja kunktacja koncentracja", "specjalizacja, kunktacja, koncentracja sił", "specjalizacja, kunktacja, koncentracja", "specjalizacja, kunktacja i koncentracja sił", "specjalizacja, kunktacja i koncentracja", "specjalizacja kunktacja koncentracja sil"],
                "hint": "Wytyczne sprawnego działania, przeciwieństwo dywersyfikacji."
            },
            {
                "sentence_template": "Do cech prawidłowego systemu kontroli zaliczamy: celowość, sprawność i szybkość, ___, ___, zrozumiałość.",
                "correct_answer": "obiektywność elastyczność",
                "alternative_answers": ["obiektywność, elastyczność", "obiektywnosc elastycznosc"],
                "hint": "Kontrola powinna być sprawiedliwa i bezstronna."
            },
            {
                "sentence_template": "Kontrola pełni funkcję ___, profilaktyczną, korygującą / ochronną, ___, instruktażową, pobudzającą.",
                "correct_answer": "informacyjną kreatywną",
                "alternative_answers": ["informacyjną, kreatywną", "informacyjna, kreatywna", "informacyjna kreatywna"],
                "hint": "Jedna z podstawowych funkcji kontroli, dostarczanie danych."
            },
            {
                "sentence_template": "Jeśli plan jest oparty na rzetelnej wiedzy to oznacza to, że jest on ___.",
                "correct_answer": "racjonalny",
                "hint": "Cechy dobrze przemyślanego planu."
            },
            {
                "sentence_template": "Wyróżniamy więzi organizacyjne ___, funkcjonalne, techniczne, informacyjne.",
                "correct_answer": "SŁUŻBOWE",
                "alternative_answers": ["służbowe"],
                "hint": "Rodzaje więzi organizacyjnych, te najczęściej kojarzone z hierarchią."
            },
            {
                "sentence_template": "Zgodnie z kryterium rozpiętości kierowania wyróżniamy struktury SMUKŁE i ___.",
                "correct_answer": "płaskie",
                "alternative_answers": ["plaskie"],
                "hint": "Przeciwieństwo smukłej struktury."
            },
            {
                "sentence_template": "Polityka i zarządzanie w przedsiębiorstwie, nadzór, zarobki i stosunki interpersonalne ze współpracownikami i warunki pracy to przykłady czynników ___, które powodują ___ pracownika zgodnie z teorią motywacji Herzberga.",
                "correct_answer": "higieny niezadowolenie",
                "alternative_answers": ["higieniczne niezadowolenie", "higieny, niezadowolenie", "higieniczne, niezadowolenie"],
                "hint": "Herzberg'a: co powoduje niezadowolenie, jeśli jest źle, ale nie motywuje, jeśli jest dobrze?"
            },
            {
                "sentence_template": "Zgodnie z teorią motywacji Alderfera wyróżniamy potrzeby: społeczne, ___ i ___.",
                "correct_answer": "rozwojowe egzystencjalne",
                "alternative_answers": ["rozwojowe, egzystencjalne", "rozwoju egzystencji", "rozwojowe egzystencji", "egzystencjalne rozwojowe"], // Dodano kolejność
                "hint": "Trzy kategorie potrzeb według Alderfera, podstawowe potrzeby."
            },
            {
                "sentence_template": "Zgodnie z teorią ___ ___ ___ człowieka cechuje motywacja, jeśli jego reakcje na bodźce są konsekwentne i zgodne z dotychczasowymi wzorcami zachowań.",
                "correct_answer": "Burrhus Frederic Skinner",
                "alternative_answers": ["Burrhusa Fredericka Skinnera"],
                "hint": "Teoria, która mówi o uczeniu się poprzez nagrody i kary."
            },
            {
                "sentence_template": "Badania okresowe, ubezpieczenia, wynagrodzenie w okresie choroby, wypłaty w razie redukcji zatrudnienia to przykłady ___ zabezpieczających.",
                "correct_answer": "świadczeń",
                "alternative_answers": ["swiadczen"],
                "hint": "Dodatkowe korzyści dla pracownika."
            },
            {
                "sentence_template": "Wyróżniamy następujące funkcje zarządzania: ___, ___, ___, ___.",
                "correct_answer": "planowanie organizowanie motywowanie kontrolowanie",
                "alternative_answers": [
                    "planowanie, organizowanie, motywowanie, kontrolowanie",
                    "planowanie organizowanie motywowanie i kontrolowanie",
                    "planowanie, organizowanie, motywowanie i kontrolowanie"
                ],
                "hint": "Ostatnia z czterech klasycznych funkcji zarządzania."
            },
            {
                "sentence_template": "Jeśli plan jest przejrzysty i czytelny to oznacza, że jest on ___.",
                "correct_answer": "operacyjny",
                "hint": "Cechy planu, który jest gotowy do wdrożenia."
            },
            {
                "sentence_template": "W modelu struktury gronowej wyróżniamy ___ i ___.",
                "correct_answer": "pracowników projekty",
                "alternative_answers": ["pracowników, projekty", "projekty, pracowników", "projekty pracownikow"],
                "hint": "Dwa kluczowe elementy w strukturze gronowej (cluster structure)."
            },
            {
                "sentence_template": "Osiągnięcia, uznanie, sama praca, odpowiedzialność i awans to przykłady czynników ___, które dostarczają ___ zgodnie z teorią motywacji Herzberga.",
                "correct_answer": "motywacyjnych zadowolenie",
                "alternative_answers": ["motywujące zadowolenie", "motywacyjnych, zadowolenie", "motywujące, zadowolenie"],
                "hint": "Herzberg'a: co naprawdę motywuje i zadowala?"
            },
            {
                "sentence_template": "Dodatkowe wypłaty uzależnione od osiągnięć to ___.",
                "correct_answer": "premie",
                "hint": "Rodzaj dodatkowego wynagrodzenia za dobre wyniki."
            },
            {
                "sentence_template": "Samochody służbowe, subsydiowane posiłki, pomoc mieszkaniowa, pożyczki, korzystanie z obiektów socjalnych i sportowych to przykłady ___ materialnych.",
                "correct_answer": "świadczeń",
                "alternative_answers": ["swiadczen"],
                "hint": "Rzeczy, które firma zapewnia poza pensją."
            },
            {
                "sentence_template": "Kierownik podejmujący decyzje samodzielnie w modelu Likerta charakterystyczny jest dla ___ stylu kierowania.",
                "correct_answer": "autokratycznego",
                "hint": "Brak partycypacji, pełna kontrola kierownika."
            },
            {
                "sentence_template": "Organizacja rozumiana w kategorii cech, jakie można jej przypisać to ___ znaczenie organizacji.",
                "correct_answer": "atrybutowe",
                "hint": "Skupia się na właściwościach organizacji."
            },
            {
                "sentence_template": "Decyzje ze względu na szczeble zarządzania dzielimy na: ___i ___.",
                "correct_answer": "strategiczne operacyjne",
                "alternative_answers": ["strategiczne, operacyjne", "strategiczne i operacyjne"],
                "hint": "Dwa główne poziomy decyzji w organizacji."
            },
            {
                "sentence_template": "Zgodnie z paradygmatem ___ organizacja jest instrumentem realizacji celów.",
                "correct_answer": "klasycznym",
                "hint": "Paradygmat skupiający się na organizacji jako narzędziu do osiągania celów."
            }
        ];

        let currentQuestionIndex = 0;
        let score = 0;
        let shuffledQuestions = []; // Tablica na pytania po przetasowaniu
        let attemptedResults = []; // Tablica do przechowywania wyników odpowiedzi z pełnymi obiektami pytań
        let isTransitioning = false; // Flaga do kontroli przejścia między stanami (zapobiega podwójnym wywołaniom)

        // Elementy DOM
        const questionNumberElement = document.getElementById('questionNumber');
        const sentenceElement = document.getElementById('sentence');
        const answerInput = document.getElementById('answerInput');
        const checkButton = document.getElementById('checkButton');
        const hintButton = document.getElementById('hintButton');
        const endTestButton = document.getElementById('endTestButton');
        const nextButton = document.getElementById('nextButton');
        const retakeIncorrectButton = document.getElementById('retakeIncorrectButton');
        const restartButton = document.getElementById('restartButton');
        const feedbackElement = document.getElementById('feedback');
        const finalScoreElement = document.getElementById('finalScore');
        const incorrectAnswersSummary = document.getElementById('incorrectAnswersSummary');
        const progressBarContainer = document.getElementById('progressBarContainer'); // Nowy element
        const progressBar = document.getElementById('progressBar'); // Nowy element
        const resultsHistory = document.getElementById('resultsHistory'); // Nowy element
        const historyList = document.getElementById('historyList'); // Nowy element

        const LOCAL_STORAGE_KEY = 'quizResultsHistory'; // Klucz do Local Storage

        // Funkcja do tasowania tablicy (algorytm Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Funkcja do aktualizacji paska postępu
        function updateProgressBar() {
            if (shuffledQuestions.length === 0) {
                progressBar.style.width = '0%';
                return;
            }
            const progress = (currentQuestionIndex / shuffledQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // Funkcja wyświetlająca pytanie
        function displayQuestion() {
            feedbackElement.classList.add('hidden');
            feedbackElement.classList.remove('feedback-correct', 'feedback-incorrect', 'feedback-warning');
            answerInput.classList.remove('hidden');
            checkButton.classList.remove('hidden');
            hintButton.classList.remove('hidden');
            endTestButton.classList.remove('hidden');
            nextButton.classList.add('hidden');
            restartButton.classList.add('hidden');
            retakeIncorrectButton.classList.add('hidden');
            finalScoreElement.classList.add('hidden');
            incorrectAnswersSummary.classList.add('hidden');
            incorrectAnswersSummary.querySelector('ul').innerHTML = '';
            answerInput.classList.remove('input-correct-glow');
            resultsHistory.classList.add('hidden'); // Ukryj historię wyników

            isTransitioning = false; // Zresetuj flagę przejścia, aplikacja gotowa na nową interakcję

            if (currentQuestionIndex < shuffledQuestions.length) {
                const question = shuffledQuestions[currentQuestionIndex];
                questionNumberElement.textContent = `Pytanie ${currentQuestionIndex + 1} z ${shuffledQuestions.length}`;
                sentenceElement.innerHTML = question.sentence_template.replace('___', '<span class="blank-space"></span>');
                answerInput.value = '';
                answerInput.disabled = false;
                answerInput.focus();
                updateProgressBar(); // Aktualizuj pasek postępu
            } else {
                endTest();
            }
        }

        // Funkcja do normalizacji odpowiedzi (małe litery, bez nadmiernych spacji, bez znaków diakrytycznych)
        function normalizeAnswer(answer) {
            return answer
                .toLowerCase()
                .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"") // Usuń interpunkcję
                .replace(/\s+/g, ' ') // Zamień wielokrotne spacje na pojedyncze
                .trim()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Usuń znaki diakrytyczne
        }

        // Funkcja do sprawdzania odpowiedzi
        function checkAnswer() {
            if (answerInput.disabled || isTransitioning) { 
                return;
            }

            const userAnswerRaw = answerInput.value.trim();
            
            if (userAnswerRaw === '') {
                feedbackElement.textContent = 'Proszę wpisać odpowiedź przed sprawdzeniem.';
                feedbackElement.classList.remove('hidden', 'feedback-correct', 'feedback-incorrect');
                feedbackElement.classList.add('feedback-warning');
                return;
            }

            isTransitioning = true;

            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            const userAnswerProcessed = normalizeAnswer(userAnswerRaw);
            
            const possibleCorrectAnswers = [
                normalizeAnswer(currentQuestion.correct_answer)
            ];
            if (currentQuestion.alternative_answers) {
                currentQuestion.alternative_answers.forEach(alt => {
                    possibleCorrectAnswers.push(normalizeAnswer(alt));
                });
            }

            feedbackElement.classList.remove('hidden', 'feedback-warning');
            let isAnswerCorrect = false;

            if (possibleCorrectAnswers.includes(userAnswerProcessed)) {
                feedbackElement.textContent = 'Poprawna odpowiedź!';
                feedbackElement.classList.add('feedback-correct');
                feedbackElement.classList.remove('feedback-incorrect');
                score++;
                isAnswerCorrect = true;
                answerInput.classList.add('input-correct-glow');
            } else {
                feedbackElement.textContent = `Błędna odpowiedź. Poprawna to: "${currentQuestion.correct_answer}"`;
                feedbackElement.classList.add('feedback-incorrect');
                feedbackElement.classList.remove('feedback-correct');
                isAnswerCorrect = false;
                answerInput.classList.remove('input-correct-glow');
            }

            attemptedResults.push({
                originalQuestion: currentQuestion, 
                userAnswer: userAnswerRaw,
                isCorrect: isAnswerCorrect
            });

            answerInput.disabled = true;

            setTimeout(() => {
                checkButton.classList.add('hidden');
                hintButton.classList.add('hidden');
                endTestButton.classList.add('hidden');
                nextButton.classList.remove('hidden');
                nextButton.focus();
            }, 1500);
        }

        // Funkcja do pokazywania podpowiedzi
        function showHint() {
            const hint = shuffledQuestions[currentQuestionIndex].hint;
            if (hint) {
                feedbackElement.textContent = `Podpowiedź: ${hint}`;
                feedbackElement.classList.remove('hidden', 'feedback-correct', 'feedback-incorrect', 'feedback-warning');
                feedbackElement.style.color = '#555';
                feedbackElement.style.borderColor = '#aaa';
                feedbackElement.style.backgroundColor = '#f0f0f0';
            } else {
                feedbackElement.textContent = 'Brak podpowiedzi dla tego pytania.';
                feedbackElement.classList.remove('hidden', 'feedback-correct', 'feedback-incorrect', 'feedback-warning');
                feedbackElement.style.color = '#888';
                feedbackElement.style.borderColor = '#ccc';
                feedbackElement.style.backgroundColor = '#f9f9f9';
            }
        }

        // Funkcja do przejścia do następnego pytania z debouncingiem
        let nextButtonTimeoutId = null;
        function nextQuestion() {
            if (nextButtonTimeoutId) {
                clearTimeout(nextButtonTimeoutId);
            }
            nextButtonTimeoutId = setTimeout(() => {
                currentQuestionIndex++;
                displayQuestion();
                nextButtonTimeoutId = null;
            }, 50); 
        }

        // Funkcje do zarządzania historią wyników w Local Storage
        function saveResultToHistory(score, totalQuestions, type) {
            let history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            const now = new Date();
            const dateString = now.toLocaleDateString('pl-PL', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
            history.push({
                score: score,
                total: totalQuestions,
                type: type, // 'pełny' lub 'błędne'
                date: dateString
            });
            // Ogranicz liczbę wyników do np. 10 ostatnich
            if (history.length > 10) {
                history = history.slice(history.length - 10);
            }
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(history));
            displayResultsHistory(); // Odśwież wyświetlanie historii
        }

        function displayResultsHistory() {
            const history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
            historyList.innerHTML = '';
            if (history.length === 0) {
                historyList.innerHTML = '<li>Brak zapisanych wyników.</li>';
                resultsHistory.classList.remove('hidden');
                return;
            }

            history.reverse().forEach(entry => { // Wyświetlaj najnowsze na górze
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="score-text">Wynik: ${entry.score} / ${entry.total} (${entry.type})</span>
                    <span class="date-text">${entry.date}</span>
                `;
                historyList.appendChild(listItem);
            });
            resultsHistory.classList.remove('hidden');
        }


        // Funkcja: Zakończenie testu
        function endTest() {
            questionNumberElement.textContent = '';
            sentenceElement.textContent = 'Test zakończony!';
            finalScoreElement.textContent = `Twój wynik: ${score} / ${shuffledQuestions.length}`;
            finalScoreElement.classList.remove('hidden');

            // Określ typ testu do zapisu w historii
            const testType = (shuffledQuestions.length === questions.length) ? 'pełny' : 'błędne';
            saveResultToHistory(score, shuffledQuestions.length, testType); // Zapisz wynik

            answerInput.classList.add('hidden');
            answerInput.disabled = true;
            checkButton.classList.add('hidden');
            hintButton.classList.add('hidden');
            endTestButton.classList.add('hidden');
            nextButton.classList.add('hidden');
            feedbackElement.classList.add('hidden');
            feedbackElement.classList.remove('feedback-correct', 'feedback-incorrect', 'feedback-warning');
            progressBarContainer.classList.add('hidden'); // Ukryj pasek postępu

            answerInput.classList.remove('input-correct-glow');

            const ulElement = incorrectAnswersSummary.querySelector('ul');
            ulElement.innerHTML = '';

            let hasIncorrectAnswers = false;
            attemptedResults.forEach(result => {
                if (!result.isCorrect) {
                    hasIncorrectAnswers = true;
                    const listItem = document.createElement('li');
                    const filledSentence = result.originalQuestion.sentence_template.replace(
                        '___',
                        `<span class="your-answer">${result.userAnswer || '[brak odpowiedzi]'}</span>`
                    );
                    listItem.innerHTML = `
                        <p class="original-sentence">Pytanie ${result.originalQuestion.sentence_template.replace('___', '______')}</p>
                        <p>Twoja odpowiedź: <span class="your-answer">${result.userAnswer || '[brak]'}</span></p>
                        <p>Poprawna odpowiedź: <span class="correct-answer">${result.originalQuestion.correct_answer}</span></p>
                    `;
                    ulElement.appendChild(listItem);
                }
            });

            if (hasIncorrectAnswers) {
                incorrectAnswersSummary.classList.remove('hidden');
                retakeIncorrectButton.classList.remove('hidden');
            } else {
                sentenceElement.textContent = 'Gratulacje! Odpowiedziałeś/aś poprawnie na wszystkie pytania.';
                incorrectAnswersSummary.classList.add('hidden');
                retakeIncorrectButton.classList.add('hidden');
            }

            restartButton.classList.remove('hidden');
            restartButton.focus();
        }

        // Nowa funkcja: Powtórz test tylko z błędnymi odpowiedziami
        function retakeIncorrectAnswers() {
            score = 0;
            currentQuestionIndex = 0;
            
            const incorrectQuestions = attemptedResults
                .filter(result => !result.isCorrect)
                .map(result => result.originalQuestion);

            attemptedResults = []; 

            if (incorrectQuestions.length > 0) {
                shuffledQuestions = shuffleArray(incorrectQuestions);
                progressBarContainer.classList.remove('hidden'); // Pokaż pasek postępu
                displayQuestion();
            } else {
                sentenceElement.textContent = 'Brak pytań do powtórzenia. Brawo!';
                retakeIncorrectButton.classList.add('hidden');
                restartButton.classList.remove('hidden');
                progressBarContainer.classList.add('hidden'); // Ukryj pasek postępu
                displayResultsHistory(); // Pokaż historię, jeśli nie ma pytań do powtórki
            }
        }


        // Funkcja do restartu aplikacji (pełny test)
        function restartApp() {
            score = 0;
            currentQuestionIndex = 0;
            attemptedResults = [];
            shuffledQuestions = shuffleArray([...questions]);
            progressBarContainer.classList.remove('hidden'); // Pokaż pasek postępu
            displayQuestion();
        }

        // Obsługa zdarzeń
        checkButton.addEventListener('click', checkAnswer);
        hintButton.addEventListener('click', showHint);
        endTestButton.addEventListener('click', endTest);
        nextButton.addEventListener('click', nextQuestion);
        restartButton.addEventListener('click', restartApp);
        retakeIncorrectButton.addEventListener('click', retakeIncorrectAnswers);

        // Zmodyfikowana obsługa klawisza Enter
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (!answerInput.disabled && !isTransitioning) {
                    checkAnswer();
                } else if (!nextButton.classList.contains('hidden')) {
                    nextButton.click(); 
                } else if (!retakeIncorrectButton.classList.contains('hidden')) {
                    retakeIncorrectButton.click();
                } else if (!restartButton.classList.contains('hidden')) {
                    restartButton.click();
                }
                e.preventDefault();
            }
        });

        // Inicjalizacja aplikacji - tasowanie pytań i wyświetlenie pierwszego
        // Wywołaj displayResultsHistory na starcie, aby pokazać historię, jeśli użytkownik nie jest w trakcie quizu
        restartApp(); // Rozpocznij quiz
        // Jeśli chcesz, aby historia była widoczna od razu po załadowaniu strony, bez rozpoczynania quizu:
        // Możesz wywołać displayResultsHistory() tutaj, a restartApp() przenieść do przycisku "Rozpocznij Quiz"
        // Na potrzeby obecnej struktury, po prostu upewnij się, że historia jest widoczna po zakończeniu testu.
    </script>

</body>
</html>
